<div class="alta-usuario-container">
  <div class="header-actions">
    <ion-text color="dark">
      <h2 class="page-title">Alta de Usuario</h2>
    </ion-text>

    <div class="actions-row">
      <ion-searchbar
        (ionInput)="onSearchChange($event)"
        placeholder="Buscar por Nombre"
        debounce="500"
        class="custom-search-bar"
      ></ion-searchbar>

      <ion-button
        (click)="changeToNewState()"
        fill="solid"
        class="custom-button btn-new"
        [disabled]="uiState === 'new'"
      >
        Nuevo
      </ion-button>
    </div>
  </div>

  <ion-card class="data-card">
    <ion-card-content class="data-content-area">

      <div *ngIf="uiState === 'view'" class="table-container">
        <div class="table-header">
          <div class="header-cell">Nombre</div>
          <div class="header-cell">Apellidos</div>
          <div class="header-cell">Correo</div>
          <div class="header-cell">Grado</div>
          <div class="header-cell">Grupo</div>
          <div class="header-cell">Categoría</div>
          <div class="header-cell">Celular</div>
          <div class="header-cell">Acción</div>
        </div>

        <div class="table-row" *ngFor="let user of filteredUsers">
          <div class="data-cell">{{ user.firstName }}</div>
          <div class="data-cell">{{ user.lastName }}</div>
          <div class="data-cell">{{ user.email }}</div>
          <div class="data-cell">{{ getGradeDescription(user.grade_id) }}</div>
          <div class="data-cell">{{ getGroupDescription(user.group_id) }}</div>
          <div class="data-cell">{{ getCategoryDescription(user.category_id) }}</div>
          <div class="data-cell">{{ user.phone }}</div>
          <div class="data-cell action-cell">
            <div class="action-wrapper">
              <button class="action-menu-btn" (click)="toggleActionMenu(user, $event)">
                <ion-icon name="ellipsis-vertical"></ion-icon>
              </button>
              <div class="action-popup" *ngIf="activeMenuUserId === getUserId(user)" (click)="$event.stopPropagation()">
                <div class="popup-option" (click)="editUser(user)">
                  <ion-icon name="create-outline"></ion-icon>
                  <span>Editar</span>
                </div>
                <div class="popup-option delete-option" (click)="confirmDelete(user)">
                  <ion-icon name="trash-outline"></ion-icon>
                  <span>Eliminar</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div *ngIf="filteredUsers.length === 0" class="no-results">
          <ion-text color="medium">
            <p>No se encontraron usuarios que coincidan con la búsqueda.</p>
          </ion-text>
        </div>
      </div>

      <!-- nuevo usuario  -->
      <div *ngIf="uiState === 'new'" class="form-container">
        <div class="table-header">
          <div class="header-cell">Nombre</div>
          <div class="header-cell">Apellidos</div>
          <div class="header-cell">Correo</div>
          <div class="header-cell">Contraseña</div>
          <div class="header-cell">Grado</div>
          <div class="header-cell">Grupo</div>
          <div class="header-cell">Categoría</div>
          <div class="header-cell">Celular</div>
        </div>

        <div class="table-row input-row">
          <div class="data-cell input-cell">
            <input type="text" [(ngModel)]="newUser.firstName" placeholder="Nombre" class="cell-input" />
          </div>
          <div class="data-cell input-cell">
            <input type="text" [(ngModel)]="newUser.lastName" placeholder="Apellidos" class="cell-input" />
          </div>
          <div class="data-cell input-cell">
            <input type="email" [(ngModel)]="newUser.email" placeholder="Correo" class="cell-input" />
          </div>
          <div class="data-cell input-cell">
            <input type="password" [(ngModel)]="newUser.password" placeholder="Contraseña" class="cell-input" />
          </div>
          <div class="data-cell input-cell">
            <ion-button (click)="openModal('grade')" fill="clear" size="small" class="select-button">
              {{ getGradeDescription(newUser.grade_id) || 'Seleccionar' }}
            </ion-button>
          </div>
          <div class="data-cell input-cell">
            <ion-button (click)="openModal('group')" fill="clear" size="small" class="select-button">
              {{ getGroupDescription(newUser.group_id) || 'Seleccionar' }}
            </ion-button>
          </div>
          <div class="data-cell input-cell">
            <ion-button (click)="openModal('category')" fill="clear" size="small" class="select-button">
              {{ getCategoryDescription(newUser.category_id) || 'Seleccionar' }}
            </ion-button>
          </div>
          <div class="data-cell input-cell">
            <input type="tel" [(ngModel)]="newUser.phone" placeholder="Celular" class="cell-input" />
          </div>
        </div>

        <div class="bottom-actions-row">
          <ion-button
            (click)="changeToViewState()"
            fill="outline"
            color="medium"
            class="action-button cancel-button"
          >
            Cancelar
          </ion-button>
          <ion-button
            (click)="confirmEdit()"
            fill="solid"
            color="primary"
            class="custom-button confirm-button"
          >
            Confirmar
          </ion-button>
        </div>
      </div>

      <!-- editar usuario  -->
      <div *ngIf="uiState === 'edit'" class="form-container">
        <div class="table-header">
          <div class="header-cell">Nombre</div>
          <div class="header-cell">Apellidos</div>
          <div class="header-cell">Correo</div>
          <div class="header-cell">Grado</div>
          <div class="header-cell">Grupo</div>
          <div class="header-cell">Categoría</div>
          <div class="header-cell">Celular</div>
        </div>

        <div class="table-row input-row edit-row">
          <div class="data-cell input-cell">
            <input type="text" [(ngModel)]="editingUser.firstName" placeholder="Nombre" class="cell-input" />
          </div>
          <div class="data-cell input-cell">
            <input type="text" [(ngModel)]="editingUser.lastName" placeholder="Apellidos" class="cell-input" />
          </div>
          <div class="data-cell input-cell">
            <input type="email" [(ngModel)]="editingUser.email" placeholder="Correo" class="cell-input" disabled />
          </div>
          <div class="data-cell input-cell">
            <ion-button (click)="openModal('grade')" fill="clear" size="small" class="select-button">
              {{ getGradeDescription(editingUser.grade_id) || 'Seleccionar' }}
            </ion-button>
          </div>
          <div class="data-cell input-cell">
            <ion-button (click)="openModal('group')" fill="clear" size="small" class="select-button">
              {{ getGroupDescription(editingUser.group_id) || 'Seleccionar' }}
            </ion-button>
          </div>
          <div class="data-cell input-cell">
            <ion-button (click)="openModal('category')" fill="clear" size="small" class="select-button">
              {{ getCategoryDescription(editingUser.category_id) || 'Seleccionar' }}
            </ion-button>
          </div>
          <div class="data-cell input-cell">
            <input type="tel" [(ngModel)]="editingUser.phone" placeholder="Celular" class="cell-input" />
          </div>
        </div>

        <div class="bottom-actions-row">
          <ion-button
            (click)="changeToViewState()"
            fill="outline"
            color="medium"
            class="action-button cancel-button"
          >
            Cancelar
          </ion-button>
          <ion-button
            (click)="confirmEditUser()"
            fill="solid"
            color="primary"
            class="custom-button confirm-button"
          >
            Confirmar
          </ion-button>
        </div>
      </div>

      <div *ngIf="uiState === 'skeleton'" class="table-container">
        <div class="table-header">
          <div class="header-cell">Nombre</div>
          <div class="header-cell">Apellidos</div>
          <div class="header-cell">Correo</div>
          <div class="header-cell">Grado</div>
          <div class="header-cell">Grupo</div>
          <div class="header-cell">Categoría</div>
          <div class="header-cell">Celular</div>
        </div>

        <div class="table-row" *ngFor="let i of [1, 2, 3, 4, 5]">
          <div class="data-cell"><ion-skeleton-text animated style="width: 80%"></ion-skeleton-text></div>
          <div class="data-cell"><ion-skeleton-text animated style="width: 70%"></ion-skeleton-text></div>
          <div class="data-cell"><ion-skeleton-text animated style="width: 90%"></ion-skeleton-text></div>
          <div class="data-cell"><ion-skeleton-text animated style="width: 60%"></ion-skeleton-text></div>
          <div class="data-cell"><ion-skeleton-text animated style="width: 50%"></ion-skeleton-text></div>
          <div class="data-cell"><ion-skeleton-text animated style="width: 70%"></ion-skeleton-text></div>
          <div class="data-cell"><ion-skeleton-text animated style="width: 65%"></ion-skeleton-text></div>
        </div>
      </div>

      <div *ngIf="uiState === 'empty'" class="empty-state">
        <ion-text color="medium">
          <ion-icon name="search-outline" size="large"></ion-icon>
          <h3>Sin Resultados</h3>
          <p>No se encontraron usuarios que coincidan con su búsqueda.</p>
        </ion-text>
      </div>

      <div *ngIf="uiState === 'error'" class="error-state">
        <ion-text color="danger">
          <ion-icon name="close-circle-outline" size="large"></ion-icon>
          <h3>Error de Conexión</h3>
          <p>Ocurrió un problema al cargar los datos. Inténtelo de nuevo más tarde.</p>
        </ion-text>
      </div>

    </ion-card-content>
  </ion-card>

  <ion-modal [isOpen]="isGradeModalOpen" (didDismiss)="closeModal('grade')">
    <ng-template>
      <ion-header>
        <ion-toolbar color="primary">
          <ion-title>Seleccionar Grado</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="closeModal('grade')">Cerrar</ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      <ion-content>
        <ion-list>
          <ion-item *ngFor="let grade of allGrades" button (click)="selectGrade(grade)">
            <ion-label>{{ grade.desc }}</ion-label>
          </ion-item>
        </ion-list>
      </ion-content>
    </ng-template>
  </ion-modal>

  <ion-modal [isOpen]="isGroupModalOpen" (didDismiss)="closeModal('group')">
    <ng-template>
      <ion-header>
        <ion-toolbar color="primary">
          <ion-title>Seleccionar Grupo</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="closeModal('group')">Cerrar</ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      <ion-content>
        <ion-list>
          <ion-item *ngFor="let group of allGroups" button (click)="selectGroup(group)">
            <ion-label>{{ group.desc }}</ion-label>
          </ion-item>
        </ion-list>
      </ion-content>
    </ng-template>
  </ion-modal>

  <ion-modal [isOpen]="isCategoryModalOpen" (didDismiss)="closeModal('category')">
    <ng-template>
      <ion-header>
        <ion-toolbar color="primary">
          <ion-title>Seleccionar Categoría</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="closeModal('category')">Cerrar</ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      <ion-content>
        <ion-list>
          <ion-item *ngFor="let category of allCategories" button (click)="selectCategory(category)">
            <ion-label>{{ category.desc }}</ion-label>
          </ion-item>
        </ion-list>
      </ion-content>
    </ng-template>
  </ion-modal>

  <!-- confirmar eliminación -->
  <ion-modal [isOpen]="isDeleteModalOpen" (didDismiss)="closeDeleteModal()" class="delete-modal">
    <ng-template>
      <div class="delete-modal-content">
        <div class="delete-icon-container">
          <ion-icon name="warning-outline" color="danger"></ion-icon>
        </div>
        <h2>¿Eliminar usuario?</h2>
        <p>¿Seguro que deseas eliminar este usuario?</p>
        <p class="user-name">{{ userToDelete?.firstName }} {{ userToDelete?.lastName }}</p>
        
        <div class="delete-modal-actions">
          <ion-button
            (click)="closeDeleteModal()"
            fill="outline"
            color="medium"
            class="modal-cancel-button"
          >
            Cancelar
          </ion-button>
          <ion-button
            (click)="deleteUser()"
            fill="solid"
            color="danger"
            class="modal-confirm-button"
          >
            Confirmar
          </ion-button>
        </div>
      </div>
    </ng-template>
  </ion-modal>

</div>
