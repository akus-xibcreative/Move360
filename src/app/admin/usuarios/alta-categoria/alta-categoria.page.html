<div class="alta-categoria-usuario-container">
    <div class="header-actions">
      <ion-text color="dark">
        <h2 class="page-title">Alta de Categoría de Usuario</h2>
      </ion-text>

      <div class="actions-row">
        <ion-searchbar
          placeholder="Buscar por nombre de clave"
          debounce="300"
          class="custom-search-bar"
          (ionInput)="filterCategories($event)"
        ></ion-searchbar>

        <ion-button
          (click)="changeToNewState()"
          fill="solid"
          class="custom-button btn-new"
          [disabled]="uiState === 'new'"
        >
          Nuevo
        </ion-button>
      </div>
    </div>

    <ion-card class="data-card">
      <ion-card-content class="data-content-area">

        <div *ngIf="uiState === 'view'" class="table-container">
          <div class="table-header">
            <div class="header-cell">Clave</div>
            <div class="header-cell">Descripción</div>
            <div class="header-cell seq-cell">Secuencia</div>
            <div class="header-cell">Acción</div>
          </div>

          <div class="table-row" *ngFor="let category of filteredCategories; let i = index">
            <div class="data-cell">{{ category.id }}</div>
            <div class="data-cell">{{ category.desc }}</div>
            <div class="data-cell seq-cell">{{ category.seq }}</div>
            <div class="data-cell action-cell">
              <div class="action-wrapper">
                <button class="action-menu-btn" (click)="toggleActionMenu(category, $event)">
                  <ion-icon name="ellipsis-vertical"></ion-icon>
                </button>
                <div class="action-popup" 
                     *ngIf="activeMenuId === getCategoryId(category)" 
                     [class.popup-up]="isLastRows(i)"
                     (click)="$event.stopPropagation()">
                  <div class="popup-option" (click)="editCategory(category)">
                    <ion-icon name="create-outline"></ion-icon>
                    <span>Editar</span>
                  </div>
                  <div class="popup-option delete-option" (click)="confirmDelete(category)">
                    <ion-icon name="trash-outline"></ion-icon>
                    <span>Eliminar</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div *ngIf="filteredCategories.length === 0" class="no-results">
            <ion-text color="medium">
              <p>No se encontraron categorías que coincidan con la búsqueda.</p>
            </ion-text>
          </div>
        </div>

        <div *ngIf="uiState === 'new'" class="form-container">
          <div class="table-header">
            <div class="header-cell">Clave</div>
            <div class="header-cell">Descripción</div>
            <div class="header-cell seq-cell">Secuencia</div>
          </div>

          <div class="table-row input-row">
            <div class="data-cell input-cell">
              <input type="text" [(ngModel)]="newCategory.id" placeholder="Ingrese la clave" class="cell-input"/>
            </div>
            <div class="data-cell input-cell">
              <input type="text" [(ngModel)]="newCategory.desc" placeholder="Ingrese la descripción" class="cell-input"/>
            </div>
            <div class="data-cell seq-cell input-cell">
              <input type="text" inputmode="numeric" [(ngModel)]="newCategory.seq" (input)="onlyNumbers($event)" placeholder="Ingrese la secuencia" class="cell-input"/>
            </div>
          </div>

           <div class="bottom-actions-row">
            <ion-button
            (click)="changeToViewState()"
            fill="outline"
            color="medium"
            class="action-button cancel-button"
            >
            Cancelar
          </ion-button>
          <ion-button
          (click)="confirmCategory()"
          fill="solid"
          color="primary"
          class="custom-button confirm-button"
          >
          Confirmar
        </ion-button>
      </div>
        </div>

        <!-- Editar Categoría  -->
        <div *ngIf="uiState === 'edit'" class="form-container">
          <div class="table-header">
            <div class="header-cell">Clave</div>
            <div class="header-cell">Descripción</div>
            <div class="header-cell seq-cell">Secuencia</div>
          </div>

          <div class="table-row input-row">
            <div class="data-cell input-cell">
              <input type="text" [(ngModel)]="editingCategory.id" placeholder="Clave" class="cell-input" disabled/>
            </div>
            <div class="data-cell input-cell">
              <input type="text" [(ngModel)]="editingCategory.desc" placeholder="Descripción" class="cell-input"/>
            </div>
            <div class="data-cell seq-cell input-cell">
              <input type="text" inputmode="numeric" [(ngModel)]="editingCategory.seq" (input)="onlyNumbers($event)" placeholder="Secuencia" class="cell-input"/>
            </div>
          </div>

           <div class="bottom-actions-row">
            <ion-button
            (click)="changeToViewState()"
            fill="outline"
            color="medium"
            class="action-button cancel-button"
            >
            Cancelar
          </ion-button>
          <ion-button
          (click)="confirmEditCategory()"
          fill="solid"
          color="primary"
          class="custom-button confirm-button"
          >
          Confirmar
        </ion-button>
      </div>
        </div>

        <div *ngIf="uiState === 'skeleton'" class="table-container">
          <div class="table-header">
            <div class="header-cell">Clave</div>
            <div class="header-cell">Descripción</div>
            <div class="header-cell seq-cell">Secuencia</div>
          </div>

          <div class="table-row" *ngFor="let i of [1, 2, 3, 4, 5]">
            <div class="data-cell"><ion-skeleton-text animated style="width: 80%"></ion-skeleton-text></div>
            <div class="data-cell"><ion-skeleton-text animated style="width: 90%"></ion-skeleton-text></div>
            <div class="data-cell seq-cell"><ion-skeleton-text animated style="width: 50%"></ion-skeleton-text></div>
          </div>
        </div>

        <div *ngIf="uiState === 'empty'" class="empty-state">
          <ion-icon name="search-outline" size="large"></ion-icon>
          <ion-text color="medium">
            <h3>Sin Resultados</h3>
            <p>No se encontraron categorías que coincidan con su búsqueda.</p>
          </ion-text>
        </div>

        <div *ngIf="uiState === 'error'" class="error-state">
          <ion-icon name="close-circle-outline" size="large"></ion-icon>
          <ion-text color="danger">
            <h3>Error de Conexión</h3>
            <p>Ocurrió un problema al cargar los datos. Inténtelo de nuevo más tarde.</p>
          </ion-text>
        </div>

      </ion-card-content>
    </ion-card>

    <!-- Modal Confirmar Eliminación -->
    <ion-modal [isOpen]="isDeleteModalOpen" (didDismiss)="closeDeleteModal()" class="delete-modal">
      <ng-template>
        <div class="delete-modal-content">
          <div class="delete-icon-container">
            <ion-icon name="warning-outline" color="danger"></ion-icon>
          </div>
          <h2>¿Eliminar categoría?</h2>
          <p>¿Seguro que deseas eliminar esta categoría?</p>
          <p class="item-name">{{ itemToDelete?.id }} - {{ itemToDelete?.desc }}</p>
          
          <div class="delete-modal-actions">
            <ion-button
              (click)="closeDeleteModal()"
              fill="outline"
              color="medium"
              class="modal-cancel-button"
            >
              Cancelar
            </ion-button>
            <ion-button
              (click)="deleteItem()"
              fill="solid"
              color="danger"
              class="modal-confirm-button"
            >
              Confirmar
            </ion-button>
          </div>
        </div>
      </ng-template>
    </ion-modal>

</div>
