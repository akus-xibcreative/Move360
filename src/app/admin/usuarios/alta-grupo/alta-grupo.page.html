<div class="alta-grupo-container">

    <div class="header-actions">
      <ion-text color="dark">
        <h2 class="page-title">Alta de Grupo</h2>
      </ion-text>

      <div class="actions-row">
        <ion-searchbar
          placeholder="Buscar por clave"
          debounce="300"
          class="custom-search-bar"
          (ionInput)="filterGroups($event)"
        ></ion-searchbar>

        <ion-button
          (click)="changeToNewState()"
          fill="solid"
          class="custom-button btn-new"
          [disabled]="uiState === 'new'"
        >
          Nuevo
        </ion-button>
      </div>
    </div>

    <ion-card class="data-card">
      <ion-card-content class="data-content-area">

                <div *ngIf="uiState === 'view'" class="table-container">

        <div class="table-header">
            <div class="header-cell">Clave</div>
            <div class="header-cell">Descripción</div>
            <div class="header-cell seq-cell">Secuencia</div>
            <div class="header-cell">Acción</div>
          </div>

          <div class="table-row" *ngFor="let group of filteredGroups; let i = index">
            <div class="data-cell">{{ group.id }}</div>
            <div class="data-cell">{{ group.desc }}</div>
            <div class="data-cell seq-cell">{{ group.seq }}</div>
            <div class="data-cell action-cell">
              <div class="action-wrapper">
                <button class="action-menu-btn" (click)="toggleActionMenu(group, $event)">
                  <ion-icon name="ellipsis-vertical"></ion-icon>
                </button>
                <div class="action-popup"
                     *ngIf="activeMenuId === getGroupId(group)"
                     [class.popup-up]="isLastRows(i)"
                     (click)="$event.stopPropagation()">
                  <div class="popup-option" (click)="editGroup(group)">
                    <ion-icon name="create-outline"></ion-icon>
                    <span>Editar</span>
                  </div>
                  <div class="popup-option delete-option" (click)="confirmDelete(group)">
                    <ion-icon name="trash-outline"></ion-icon>
                    <span>Eliminar</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div *ngIf="filteredGroups.length === 0" class="no-results">
            <ion-text color="medium">
              <p>No se encontraron grupos que coincidan con la búsqueda.</p>
            </ion-text>
          </div>
        </div>

        <div *ngIf="uiState === 'new'" class="form-container">

          <div class="table-header">
            <div class="header-cell">Clave</div>
            <div class="header-cell">Descripción</div>
            <div class="header-cell seq-cell">Secuencia</div>
          </div>

          <div class="table-row input-row">
            <div class="data-cell input-cell">
              <input type="text" [(ngModel)]="newGroup.id" placeholder="Ingrese clave" class="cell-input" />
            </div>
            <div class="data-cell input-cell">
              <input type="text" [(ngModel)]="newGroup.desc" placeholder="Ingrese descripción" class="cell-input" />
            </div>
            <div class="data-cell input-cell seq-cell">
              <input type="text" inputmode="numeric" [(ngModel)]="newGroup.seq" (input)="onlyNumbers($event)" placeholder="Ingrese secuencia" class="cell-input" />
            </div>
          </div>

      <div class="bottom-actions-row">
            <ion-button
            (click)="changeToViewState()"
            fill="outline"
            color="medium"
            class="action-button cancel-button"
            >
            Cancelar
          </ion-button>
          <ion-button
          (click)="confirmGroup()"
          fill="solid"
          color="primary"
          class="custom-button confirm-button"
          >
          Confirmar
        </ion-button>
      </div>
    </div>

    <!-- Modo Editar Grupo -->
    <div *ngIf="uiState === 'edit'" class="form-container">
      <div class="table-header">
        <div class="header-cell">Clave</div>
        <div class="header-cell">Descripción</div>
        <div class="header-cell seq-cell">Secuencia</div>
      </div>

      <div class="table-row input-row">
        <div class="data-cell input-cell">
          <input type="text" [(ngModel)]="editingGroup.id" placeholder="Clave" class="cell-input" disabled/>
        </div>
        <div class="data-cell input-cell">
          <input type="text" [(ngModel)]="editingGroup.desc" placeholder="Descripción" class="cell-input"/>
        </div>
        <div class="data-cell seq-cell input-cell">
          <input type="text" inputmode="numeric" [(ngModel)]="editingGroup.seq" (input)="onlyNumbers($event)" placeholder="Secuencia" class="cell-input"/>
        </div>
      </div>

      <div class="bottom-actions-row">
        <ion-button
          (click)="changeToViewState()"
          fill="outline"
          color="medium"
          class="action-button cancel-button"
        >
          Cancelar
        </ion-button>
        <ion-button
          (click)="confirmEditGroup()"
          fill="solid"
          color="primary"
          class="custom-button confirm-button"
        >
          Confirmar
        </ion-button>
      </div>
    </div>

    <div *ngIf="uiState === 'skeleton'" class="table-container">
          <div class="table-header">
            <div class="header-cell">Clave</div>
            <div class="header-cell">Descripción</div>
            <div class="header-cell seq-cell">Secuencia</div>
          </div>

          <div class="table-row" *ngFor="let i of [1, 2, 3]">
            <div class="data-cell"><ion-skeleton-text animated style="width: 80%"></ion-skeleton-text></div>
            <div class="data-cell"><ion-skeleton-text animated style="width: 90%"></ion-skeleton-text></div>
            <div class="data-cell seq-cell"><ion-skeleton-text animated style="width: 50%"></ion-skeleton-text></div>
          </div>
        </div>

        <div *ngIf="uiState === 'empty'" class="empty-state">
          <ion-icon name="search-outline" size="large"></ion-icon>
          <ion-text color="medium">
            <h3>Sin Resultados</h3>
            <p>No se encontraron grupos que coincidan con su búsqueda.</p>
          </ion-text>
        </div>

        <div *ngIf="uiState === 'error'" class="error-state">
          <ion-icon name="close-circle-outline" size="large"></ion-icon>
          <ion-text color="danger">
            <h3>Error de Conexión</h3>
            <p>Ocurrió un problema al cargar los datos. Inténtelo de nuevo más tarde.</p>
          </ion-text>
        </div>

      </ion-card-content>
    </ion-card>

    <!-- Modal de confirmación de eliminación -->
    <ion-modal [isOpen]="isDeleteModalOpen" (didDismiss)="closeDeleteModal()" class="delete-modal">
      <ng-template>
        <div class="delete-modal-content">
          <div class="delete-icon-container">
            <ion-icon name="warning-outline" color="danger"></ion-icon>
          </div>
          <h2>¿Eliminar Grupo?</h2>
          <p>¿Está seguro de que desea eliminar este grupo?</p>
          <strong class="item-name">{{ itemToDelete?.desc }}</strong>
          <div class="delete-modal-actions">
            <ion-button
              (click)="closeDeleteModal()"
              fill="outline"
              color="medium"
              class="modal-cancel-button"
            >
              Cancelar
            </ion-button>
            <ion-button
              (click)="deleteItem()"
              fill="solid"
              color="danger"
              class="modal-confirm-button"
            >
              Eliminar
            </ion-button>
          </div>
        </div>
      </ng-template>
    </ion-modal>

</div>
